<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JN Physiotherapy & Rehabilitation Clinic</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>

  <!-- âœ… SUPABASE -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Source+Sans+3:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body { box-sizing: border-box; }
    * { scrollbar-width: thin; scrollbar-color: #0d9488 #e5e7eb; }
    .font-heading { font-family: 'Playfair Display', serif; }
    .font-body { font-family: 'Source Sans 3', sans-serif; }
    html { scroll-behavior: smooth; }
    .review-card { transition: transform 0.3s ease; }
    .review-card:hover { transform: scale(1.02); }
    .star-btn { transition: transform 0.2s ease, color 0.2s ease; }
    .star-btn:hover { transform: scale(1.2); }
  </style>
</head>

<body class="h-full font-body bg-slate-50 text-slate-800">

<!-- ðŸ”¥ YOUR UI ABOVE IS UNCHANGED -->

<!-- ================= SUPABASE + LOGIC ================= -->
<script>
/* ================= SUPABASE ================= */
const supabase = supabaseJs.createClient(
  "https://hqjhnwsvgygexfxkcmdt.supabase.co",
  "sb_publishable_2ok_2ecW-qK_KBsVsMIOuw_DxF9AAMK"
);

/* ================= STATE ================= */
let reviews = [];
let selectedRating = 0;
let isSubmitting = false;

/* ================= LOAD REVIEWS ================= */
async function loadReviews() {
  const { data, error } = await supabase
    .from("reviews")
    .select("*")
    .order("created_at", { ascending: false });

  if (error) {
    showToast("Failed to load reviews");
    return;
  }

  reviews = data.map(r => ({
    ...r,
    __backendId: r.id,
    createdAt: r.created_at
  }));

  renderReviews();
}

loadReviews();

/* ================= STAR RATING ================= */
const starButtons = document.querySelectorAll('#star-rating .star-btn');
starButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    selectedRating = parseInt(btn.dataset.rating);
    updateStars();
  });
});

function updateStars() {
  starButtons.forEach(btn => {
    btn.style.color =
      parseInt(btn.dataset.rating) <= selectedRating ? '#f59e0b' : '#cbd5e1';
  });
}

/* ================= SUBMIT REVIEW ================= */
document.getElementById('review-form').addEventListener('submit', async e => {
  e.preventDefault();
  if (isSubmitting) return;

  const name = reviewer-name.value.trim();
  const reviewText = review-text.value.trim();

  if (!name || !selectedRating || !reviewText) {
    showToast("Fill all fields and rating");
    return;
  }

  isSubmitting = true;
  submit-review-btn.disabled = true;
  submit-review-btn.textContent = "Submitting...";

  const { error } = await supabase.from("reviews").insert({
    name,
    rating: selectedRating,
    review: reviewText
  });

  isSubmitting = false;
  submit-review-btn.disabled = false;
  submit-review-btn.textContent = "Submit Review";

  if (error) {
    showToast("Failed to submit review");
    return;
  }

  showToast("Thank you for your review!");
  e.target.reset();
  selectedRating = 0;
  updateStars();
  loadReviews();
});

/* ================= RENDER REVIEWS ================= */
function renderReviews() {
  const list = document.getElementById('reviews-list');
  const empty = document.getElementById('empty-reviews');

  list.innerHTML = "";

  if (!reviews.length) {
    empty.classList.remove("hidden");
    return;
  }

  empty.classList.add("hidden");

  reviews.forEach(review => {
    const card = document.createElement("div");
    card.className = "review-card rounded-2xl p-5 shadow-md fade-in";
    card.style.backgroundColor = "#ffffff";

    const stars = "â˜…".repeat(review.rating) + "â˜†".repeat(5 - review.rating);
    const date = new Date(review.createdAt).toLocaleDateString("en-IN", {
      day: "numeric",
      month: "short",
      year: "numeric"
    });

    card.innerHTML = `
      <div class="flex items-start gap-3 mb-3">
        <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-semibold"
             style="background: linear-gradient(135deg,#0f766e,#14b8a6)">
          ${review.name.charAt(0).toUpperCase()}
        </div>
        <div class="flex-1">
          <div class="flex justify-between">
            <h4 class="font-semibold text-teal-700">${escapeHtml(review.name)}</h4>
            <span class="text-xs text-slate-400">${date}</span>
          </div>
          <div class="text-amber-400 text-sm">${stars}</div>
        </div>
      </div>
      <p class="text-slate-600 text-sm">${escapeHtml(review.review)}</p>
    `;

    list.appendChild(card);
  });
}

/* ================= TOAST ================= */
function showToast(msg) {
  const toast = document.getElementById("toast");
  document.getElementById("toast-message").textContent = msg;
  toast.style.transform = "translateY(0)";
  toast.style.opacity = "1";
  setTimeout(() => {
    toast.style.transform = "translateY(20px)";
    toast.style.opacity = "0";
  }, 3000);
}

function escapeHtml(text) {
  const div = document.createElement("div");
  div.textContent = text;
  return div.innerHTML;
}
</script>

</body>
</html>
